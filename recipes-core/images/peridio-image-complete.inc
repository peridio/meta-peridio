inherit core-image

DEPENDS:append = " fwup-native"

IMAGE_POSTPROCESS_COMMAND += "do_fwup_image_complete; "

PERIDIO_META_AUTHOR ??= "${MAINTAINER}"
PERIDIO_META_PRODUCT ??= "${DISTRO}"
PERIDIO_META_VERSION ??= "${DISTRO_VERSION}"
PERIDIO_META_DESCRIPTION ??= "${DISTRO_NAME}"
PERIDIO_META_ARCHITECTURE ??= "${TARGET_ARCH}-${ABIEXTENSION}"
PERIDIO_META_PLATFORM ??= "${MACHINE}"

do_fwup_image_complete() {
  ROOTFS="${IMGDEPLOYDIR}/${IMAGE_NAME}.rootfs.${IMAGE_FSTYPES}" \
  PACKAGE_DIR="${DEPLOY_DIR_IMAGE}" \
  PERIDIO_FWUP_META_PRODUCT="${PERIDIO_META_PRODUCT}" \
  PERIDIO_FWUP_META_VERSION="${PERIDIO_META_VERSION}" \
  PERIDIO_FWUP_META_ARCHITECTURE="${PERIDIO_META_ARCHITECTURE}" \
  PERIDIO_FWUP_META_PLATFORM="${PERIDIO_META_PLATFORM}" \
  PERIDIO_FWUP_META_DESCRIPTION="${PERIDIO_META_DESCRIPTION}" \
  PERIDIO_FWUP_META_VCS_IDENTIFIER="${PERIDIO_META_VCS_IDENTIFIER}" \
  PERIDIO_FWUP_META_MISC="${PERIDIO_META_MISC}" \
  fwup -c -f ${DEPLOY_DIR_IMAGE}/fwup.conf -o ${IMGDEPLOYDIR}/${MACHINE}.fw
}
